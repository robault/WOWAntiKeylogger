<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" dir="ltr" lang="en"><head profile="http://gmpg.org/xfn/11">
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>Any application-defined hook procedure on my machine? « My infected computer</title>

	<style type="text/css" media="screen">
		@import url( http://s0.wp.com/wp-content/themes/pub/connections/style.css?m=1294768400g );
	</style>
	<link rel="pingback" href="http://zairon.wordpress.com/xmlrpc.php">

<!--[if IE 7]>
<style type="text/css"> 
	#topnav li {
		display: inline;
	}
</style>
<![endif]-->

	<link rel="alternate" type="application/rss+xml" title="My infected computer » Feed" href="http://zairon.wordpress.com/feed/">
<link rel="alternate" type="application/rss+xml" title="My infected computer » Comments Feed" href="http://zairon.wordpress.com/comments/feed/">
<link rel="alternate" type="application/rss+xml" title="My infected computer » Any application-defined hook procedure on my&nbsp;machine? Comments Feed" href="http://zairon.wordpress.com/2006/12/06/any-application-defined-hook-procedure-on-my-machine/feed/">
<script type="text/javascript">
/* <![CDATA[ */
function addLoadEvent(func){var oldonload=window.onload;if(typeof window.onload!='function'){window.onload=func;}else{window.onload=function(){oldonload();func();}}}
/* ]]> */
</script>
<link rel="stylesheet" href="Any%20application-defined%20hook%20procedure%20on%20my%20machine%20%20%C2%AB%20My%20infected%20computer_files/global.css" type="text/css">
<link rel="stylesheet" id="sharedaddy-css" href="Any%20application-defined%20hook%20procedure%20on%20my%20machine%20%20%C2%AB%20My%20infected%20computer_files/sharing.css" type="text/css" media="all">
<script type="text/javascript" src="Any%20application-defined%20hook%20procedure%20on%20my%20machine%20%20%C2%AB%20My%20infected%20computer_files/l10n.js"></script>
<script type="text/javascript" src="Any%20application-defined%20hook%20procedure%20on%20my%20machine%20%20%C2%AB%20My%20infected%20computer_files/jquery.js"></script>
<script type="text/javascript" src="Any%20application-defined%20hook%20procedure%20on%20my%20machine%20%20%C2%AB%20My%20infected%20computer_files/comment-reply.js"></script>
<link rel="EditURI" type="application/rsd+xml" title="RSD" href="http://zairon.wordpress.com/xmlrpc.php?rsd">
<link rel="wlwmanifest" type="application/wlwmanifest+xml" href="http://zairon.wordpress.com/wp-includes/wlwmanifest.xml"> 
<link rel="index" title="My infected computer" href="http://zairon.wordpress.com/">
<link rel="prev" title="My little hook&nbsp;analyzer" href="http://zairon.wordpress.com/2006/11/08/my-little-hook-analyzer/">
<link rel="next" title="Original anti&nbsp;Ollydbg" href="http://zairon.wordpress.com/2006/12/07/original-anti-ollydbg/">
<meta name="generator" content="WordPress.com">
<link rel="canonical" href="http://zairon.wordpress.com/2006/12/06/any-application-defined-hook-procedure-on-my-machine/">
<link rel="shortlink" href="http://wp.me/p1SCN-a">
<link rel="shortcut icon" type="image/x-icon" href="http://s1.wp.com/i/favicon-stacked.ico?m=1284002170g" sizes="16x16 24x24 32x32 48x48">
<link rel="icon" type="image/x-icon" href="http://s1.wp.com/i/favicon-stacked.ico?m=1284002170g" sizes="16x16 24x24 32x32 48x48">
<link rel="apple-touch-icon" href="http://s0.wp.com/wp-content/themes/h4/i/webclip.png?m=1250548519g">
	<style type="text/css">
	/* <![CDATA[ */
				div#likes { margin-top: 15px; }
		.like-button { border: 1px solid #eee; padding: 2px 6px; font-size: 13px; font-family: arial, tahoma, sans-serif; }
		#wpl-likebox { clear: left; font-size: 11px; font-family: arial, tahoma, verdana, sans-serif !important; min-height: 30px; margin: 10px 0 !important; padding: 5px 0 10px 0 !important; }
		#wpl-button { float: left; background: url( http://s2.wp.com/i/buttonbg.png ) top left repeat-x; margin-right: 7px; border: 1px solid #d4d4d4; -moz-border-radius: 3px; -webkit-border-radius: 3px; border-radius: 3px; }
		#wpl-button a { color: #666 !important; line-height: 130% !important; text-decoration: none !important; outline: none; float: left; padding: 3px 6px 2px 24px !important; font-size: 11px !important; background: url( http://s1.wp.com/i/likestar.png ) 6px 49.8% no-repeat; }
		#wpl-button.liked { background: #feffce; border: 1px solid #f3e389; }
		#wpl-button.liked a { color: #ba871b !important; }
		#wpl-likebox #wpl-count { min-height: 25px; line-height: 130% !important; float: left; padding-top: 4px; }
		#wpl-likebox #wpl-avatars { clear: left; max-height: 98px; overflow: hidden; margin-top: 15px; line-height: 130% !important; }
		#wpl-likebox #wpl-avatars img { border: none !important; }
		#wpl-likebox #wpl-mustlogin { line-height: 14px !important; font-size: 11px; clear: left; margin-top: 5px; background: #f0f0f0; padding: 10px; width: 65%; -moz-border-radius: 3px; -webkit-border-radius: 3px; border-radius: 3px; }
		#wpl-likebox #wpl-mustlogin a { color: #888; text-decoration: underline; }
		#wpl-likebox #wpl-mustlogin p { margin: 5px 0; padding: 0 }
		#wpl-likebox #wpl-mustlogin input.input { padding: 2px; background: #fff; font-size: 11px; font-family: inherit; border: 1px solid #ccc; -moz-box-shadow: 1px 1px 1px rgba(0, 0, 0, 0.1) inset; -webkit-box-shadow: 1px 1px 1px rgba(0, 0, 0, 0.1) inset; line-height: 12px; }
		#wpl-likebox #wpl-mustlogin input#wp-submit { border: 1px solid #ccc; font-size: 11px; background: #fafafa; repeat-x; -moz-border-radius: 3px; -webkit-border-radius: 3px; border-radius: 3px; padding: 2px 4px !important; line-height: 12px; }
		#wpl-likebox #wpl-mustlogin label { position: relative; cursor: text; }
		#wpl-likebox #wpl-mustlogin label span { position: absolute; top: 0px; left: 5px; padding: 0 !important; }
		#wpl-likebox #wpl-mustlogin label span { top /*\**/: -10px\9; }
	/* ]]> */
	</style>
	<link rel="openid.server" href="http://zairon.wordpress.com/?openidserver=1">
<link rel="openid.delegate" href="http://zairon.wordpress.com/">
<link rel="search" type="application/opensearchdescription+xml" href="http://zairon.wordpress.com/osd.xml" title="My infected computer">
<link rel="search" type="application/opensearchdescription+xml" href="http://wordpress.com/opensearch.xml" title="WordPress.com">
	<script type="text/javascript" charset="utf-8">
		try{
			var id = location.hash.match( /\#\!\/entry\/(\d+)/ )[1];
			if ( id ) {
				window.location = "http://zairon.wordpress.com?p=" + id;
			};
		}catch( error ){
		}
	</script>		
<style type="text/css">
#headimg {
	background:#7d8b5a url(http://s0.wp.com/wp-content/themes/pub/connections/img/just-train.jpg) center repeat-y;
}
#headimg h1 a, #headimg h1 a:hover, #headimg #desc {
	color: #B5C09D;
}	
</style>
<meta name="application-name" content="My infected computer"><meta name="msapplication-window" content="width=device-width;height=device-height"><meta name="msapplication-tooltip" content="something strange happens inside it"><meta name="msapplication-task" content="name=Subscribe;action-uri=http://zairon.wordpress.com/feed/;icon-uri=http://s1.wp.com/i/favicon-stacked.ico"><meta name="msapplication-task" content="name=Sign up for a free blog;action-uri=http://wordpress.com/signup/;icon-uri=http://s2.wp.com/i/favicon.ico"><meta name="msapplication-task" content="name=WordPress.com Support;action-uri=http://support.wordpress.com/;icon-uri=http://s2.wp.com/i/favicon.ico"><meta name="msapplication-task" content="name=WordPress.com Forums;action-uri=http://forums.wordpress.com/;icon-uri=http://s2.wp.com/i/favicon.ico"><link rel="stylesheet" type="text/css" id="gravatar-card-css" href="Any%20application-defined%20hook%20procedure%20on%20my%20machine%20%20%C2%AB%20My%20infected%20computer_files/hovercard.css"><link rel="stylesheet" type="text/css" id="gravatar-card-services-css" href="Any%20application-defined%20hook%20procedure%20on%20my%20machine%20%20%C2%AB%20My%20infected%20computer_files/services.css"></head>

<body>
<div id="rap">

<div id="header">
		<ul id="topnav">
		<li><a href="http://zairon.wordpress.com/" id="navHome" title="Posted Recently" accesskey="h">Home</a></li>
		<li class="page_item page-item-2"><a href="http://zairon.wordpress.com/about/" title="About">About</a></li>
<li class="page_item page-item-74"><a href="http://zairon.wordpress.com/articles/" title="Articles">Articles</a></li>
<li class="page_item page-item-75"><a href="http://zairon.wordpress.com/tools/" title="Tools">Tools</a></li>
	</ul>

	<div id="headimg">
	<h1><a href="http://zairon.wordpress.com/" title="My infected computer">My infected computer</a></h1>
	<div id="desc">something strange happens inside it</div>
	</div>
</div>	
	<div id="main">
	<div id="content">
						<div class="post-10 post type-post status-publish format-standard hentry category-reverse-engineering">
				<p class="post-date">December 6, 2006</p>
<div class="post-info"><h2 class="post-title"><a href="http://zairon.wordpress.com/2006/12/06/any-application-defined-hook-procedure-on-my-machine/" rel="bookmark" title="Permanent Link: Any application-defined hook procedure on my&nbsp;machine?">Any application-defined hook procedure on my&nbsp;machine?</a></h2>
Posted by zairon under <a href="http://en.wordpress.com/tag/reverse-engineering/" title="View all posts in Reverse Engineering" rel="category tag">Reverse Engineering</a> <br><a href="http://zairon.wordpress.com/2006/12/06/any-application-defined-hook-procedure-on-my-machine/#comments" title="Comment on Any application-defined hook procedure on my&nbsp;machine?">[9] Comments</a>&nbsp;</div>
<div class="post-content">
	<p>Some times ago my antivirus didn’t recognize a malware on my 
machine; the malware installed a keylogger and it did run silently in 
background for some hours. In general, you can discover the presence of a
 keylogger looking at the net traffic log or looking for some suspicious
 file name inside the task manager list but sometimes an application 
able to find out hooks will come in handy. At first I tried to find some
 informations browsing the net without luck. Hmm, no one has written 
such a program before? Is it possible or am I unable to use google??? I 
only got one usefull hint about the problem, nothing else.<br>
Well, I decided to take a look at the problem. All my investigations are done under Windows XP/SP1.</p>
<p>Before starting with the analysis I want to show you the declaration of the function used to set a windows hook:<br>
<font face="Courier New, Courier, mono">HHOOK SetWindowsHookEx(<br>
int idHook,              //    Specifies the type of hook procedure to be installed.<br>
HOOKPROC lpfn,              //    Pointer to the hook procedure<br>
HINSTANCE hMod,          //    Handle to the DLL containing the hook  procedure pointed to by the lpfn parameter<br>
DWORD dwThreadId     //    Specifies the identifier of the thread with which the hook procedure is to be associated<br>
);</font><br>
It’s always good to know which parameters are passed to the function 
because you’ll have to deal with them later. Ok, time to start…</p>
<p>A possible starting point is represented by win32k.sys file, it’s 
everything inside it. Looking at the implementation of  SetWindowsHookEx
 I’ve seen a call to HMAllocObject. This function is not really known 
but if you have ever read ‘Using Softice’ help file you surely read the 
phrase: “The routine HMAllocObject creates USER object types…”. 
Interesting, setting a bpx over the function I got the following 
informations:<br>
<font face="Courier New, Courier, mono"><br>
.text:BF853AAB push 34h                 ; nBytes<br>
.text:BF853AAD push 5                   ; TYPE_HOOK<br>
.text:BF853AAF push dword ptr [edi+3Ch]        ; PTHREADINFO.rpdesk<br>
.text:BF853AB2 push edi                                               ; PTHREADINFO<br>
.text:BF853AB3 call _HMAllocObject@16            ; HMAllocObject(x,x,x,x)</font></p>
<p>The function takes four parameters and the 3° parameter is related 
with the type of object that is created. In this specific case I’m 
dealing with hook so the type is TYPE_HOOK and HMAllocObject returns a 
pointer to a structure named HOOK, it contains general informations 
about the new object and it looks like:<br>
<font face="Courier New, Courier, mono">typedef struct _HOOK {<br>
ULONG         hHook;<br>
ULONG         cLockObj;<br>
PTHREADINFO    pti;<br>
ULONG         rpdesk;<br>
ULONG         pSelf;<br>
struct _HOOK    *phkNext;<br>
int        iHook;<br>
ULONG           offPfn;<br>
unsigned int    flags;<br>
int             ihmod;<br>
PTHREADINFO    ptiHooked;<br>
PDESKTOP    rpdesk;<br>
} HOOK, *PHOOK;</font></p>
<p><font face="Courier New, Courier, mono">Fields:<br>
- <em>hHook </em><br>
Handle to the hook procedure, it’s the value returned by SetWindowsHookEx and it comes from HMAllocObject<br>
- <em>clockObj </em><br>
!?!<br>
- <em>pti</em><br>
Pointer to THREADINFO structure of the process which sets the hook<br>
- <em>rpdesk</em><br>
!?!<br>
- <em>pSelf </em><br>
Pointer to this HOOK structure<br>
- <em>phkNext</em><br>
Next structure in the hook chain<br>
- <em>iHook</em><br>
Hook type (i.e. WH_MOUSE or WH_KEYBOARD). This is the first parameter passed to SetWindowsHookEx<br>
- <em>offPfn</em><br>
Offset of the filter procedure, it is obtained by a simple substration 
between the address of the hook procedure and the initial address of the
 dll<br>
- <em>flags</em><br>
HF_xxx flags (HF_GLOBALS, HF_LOCAL, HF_DESTROYED…)<br>
- <em>ihmod</em><br>
Number of hooks set into the module<br>
- <em>ptiHooked</em><br>
Pointer to THREADINFO structure of the hooked thread. If HF_GLOBAL is 
setted the pointer is setted to NULL because the hook works for every 
running thread<br>
- <em>rpdesk</em><br>
!?!</font></p>
<p>As you can see the fields are not all explained, I’ll try to gain more informations.</p>
<p>Some of the fields are filled by HMAllocObject itself and they are 
non TYPE_HOOK related field; I mean, the HOOK structure contains 
informations about the hook you want to install (i.e. the hook type, the
 offset of the filter procedure) and informations not so strictly 
related with the hook (i.e. phkNext, pSelf). Since of all the work is 
done trying to understand if there are global hooks installed on the 
system I’m only interested in TYPE_HOOK related fields and these are:<br>
1. <strong>pti</strong><br>
pti is really usefull because it gives me the possibility to access the 
process that has installed the hook. The first dword of THREADINFO 
structure is the pointer to ETHREAD structure which contains a pointer 
to EPROCESS structure. Once you have EPROCESS you can read the image 
file name (Imagfilename field) and the pid (UniqueProcessId) of the 
process that has setted the hook. At this point you can also read which 
dlls are loaded by the process or get any other usefull informations 
about it, especially which dll has the filter procedure inside. If you 
are not totally confident with undocumented structures you can even 
retrieve the informations using functions from Psapi library (i.e. 
EnumProcessModules/GetModuleFileNameEx to obtain a loaded dll…).<br>
2.<strong> iHook</strong><br>
without it you won’t be able to know which hook was installed.<br>
3. <strong>offPfn</strong><br>
only necessary if you want to know where the filter procedure is located at.</p>
<p>Starting from the HOOK structure I can retrieve all the needed 
informations about the HOOK but I need a fundamental information, maybe 
the most important one. Where can I find the HOOK structure? As I said 
before I only got an hint about the problem, it comes from an old thread
 at sysinternals forum (htt://forum.sysinternals.com/); I don’t remember
 the name of the user, thanks to him btw. The hint sounds like: “look at
 aphkStart”, nothing else. aphkStart is defined as:</p>
<p><font face="Courier New, Courier, mono">PHOOK aphkStart[CWINHOOKS];</font></p>
<p>It’s an array of pointers to HOOK structure, one for each possible 
WH_xxx hook; the pointer at index ‘i’ is NULL if you are not under the 
hook. As far as I have seen there are two aphkStart arrays, one for 
local hooks (inside THREADINFO structure) and one for global hooks 
(inside DESKTOPINFO structure). To find out if a global hook has been 
installed you only have to scan the entire aphkStart array (the one 
inside DESKTOPINFO) looking for a not NULL entry, if you find it you are
 under a global hook.</p>
<p>The picture below represents a little sum-up. You start from the TEB 
of the current process, the process that check the installed hooks. When
 you have the TEB you can pass through some structures:<br>
1. From TEB.Win32ThreadInfo you get THREADINFO structure<br>
2. From THREADINFO.pDeskInfo you get DESKTOPINFO structure<br>
3. If DESKTOPINFO.aphkStart[i] is not NULL you get HOOK structure of 
WH_i hook otherwise WH_i hook is not installed and you can check the 
next one, WH_i+1<br>
4. From HOOK.pti you get THREADINFO structure of the process that has setted the hook<br>
5. From THREADINFO.pEthread you get ETHREAD structure<br>
6. From ETHREAD.ThreadsProcess you get EPROCESS structure<br>
Inside EPROCESS there are many informations about the process, just read the necessary ones.</p>
<p><img src="Any%20application-defined%20hook%20procedure%20on%20my%20machine%20%20%C2%AB%20My%20infected%20computer_files/5vxyu6umzh.jpg" alt="Way to installed WH_xxx hook" height="392" width="492">
</p><div class="snap_nopreview sharing robots-nocontent">
<ul>
<li class="sharing_label">Share this:</li>
<li class="share-custom"><a href="#" class="sharing-anchor share-service-visible">Share</a></li>
<li class="share-end"></li>
</ul>
<div class="sharing-hidden">
<div class="inner" style="display: none;">
<ul>
<li class="share-facebook"><a rel="nofollow" class="share-facebook share-icon" href="http://zairon.wordpress.com/2006/12/06/any-application-defined-hook-procedure-on-my-machine/?share=facebook&amp;nb=1" target="_blank" title="Share on Facebook">Facebook</a></li>
<li class="share-twitter">
<div class="twitter_button"><iframe allowtransparency="true" src="Any%20application-defined%20hook%20procedure%20on%20my%20machine%20%20%C2%AB%20My%20infected%20computer_files/tweet_button.htm" style="width: 97px; height: 20px;" frameborder="0" scrolling="no"></iframe></div>
</li>
<li class="share-end"></li>
<li class="share-reddit"><a rel="nofollow" class="share-reddit share-icon" href="http://zairon.wordpress.com/2006/12/06/any-application-defined-hook-procedure-on-my-machine/?share=reddit&amp;nb=1" target="_blank" title="Click to share on Reddit">Reddit</a></li>
<li class="share-stumbleupon"><a rel="nofollow" class="share-stumbleupon share-icon" href="http://zairon.wordpress.com/2006/12/06/any-application-defined-hook-procedure-on-my-machine/?share=stumbleupon&amp;nb=1" target="_blank" title="Click to share on StumbleUpon">StumbleUpon</a></li>
<li class="share-end"></li>
<li class="share-digg"><a rel="nofollow" class="share-digg share-icon" href="http://zairon.wordpress.com/2006/12/06/any-application-defined-hook-procedure-on-my-machine/?share=digg&amp;nb=1" target="_blank" title="Click to Digg this post">Digg</a></li>
<li class="share-end"></li>
</ul>
</div>
</div>
<div class="sharing-clear"></div>
</div>
	<div class="post-info">
													
	</div>
	<div class="post-footer">&nbsp;</div>
</div>
				<div id="wpl-likebox"><div id="wpl-button"><a href="http://zairon.wordpress.com/2006/12/06/any-application-defined-hook-procedure-on-my-machine/?like=1&amp;_wpnonce=5c7769c103" title="I like this post" class="like needs-login" rel="nofollow"><span>Like</span></a></div><div id="wpl-count">Be the first to like this post.</div></div>	<h3 id="comments">9 Responses to “Any application-defined hook procedure on my&nbsp;machine?”</h3>

	<ol class="commentlist">
	<li class="comment even thread-even depth-1" id="comment-3767">
	<div id="div-comment-3767">
	<div class="comment-author vcard">
		<img id="grav-1c354712877789bbdd79815cca0598bf-0" alt="" src="Any%20application-defined%20hook%20procedure%20on%20my%20machine%20%20%C2%AB%20My%20infected%20computer_files/1c354712877789bbdd79815cca0598bf.png" class="avatar avatar-48 grav-hashed grav-hijack" height="48" width="48">		<cite class="fn">Chris Hall</cite> <span class="says">Says:</span>	</div>
		<br>

	<small class="comment-meta commentmetadata"><a href="http://zairon.wordpress.com/2006/12/06/any-application-defined-hook-procedure-on-my-machine/#comment-3767" title="">
	December 20, 2007 at 1:35 pm</a> </small>

	<p>Where can I find information relating to the various structs you refer to?</p>
<p>e.g. THREADINFO, DESKTOPINFO</p>
<p>Thanks</p>
	
	<div class="reply">
		<a class="comment-reply-link" href="http://zairon.wordpress.com/2006/12/06/any-application-defined-hook-procedure-on-my-machine/?replytocom=3767#respond" onclick='return addComment.moveForm("div-comment-3767", "3767", "respond", "10")'>Reply</a>	</div>
	</div>
</li>
<li class="comment byuser comment-author-zairon bypostauthor odd alt thread-odd thread-alt depth-1" id="comment-3769">
	<div id="div-comment-3769">
	<div class="comment-author vcard">
		<img id="grav-96af3de97184170603a7cc688cbafeee-0" alt="" src="Any%20application-defined%20hook%20procedure%20on%20my%20machine%20%20%C2%AB%20My%20infected%20computer_files/96af3de97184170603a7cc688cbafeee.jpg" class="avatar avatar-48 grav-hashed grav-hijack" height="48" width="48">		<cite class="fn"><a href="http://zairon.wordpress.com/" rel="external nofollow" class="url">zairon</a></cite> <span class="says">Says:</span>	</div>
		<br>

	<small class="comment-meta commentmetadata"><a href="http://zairon.wordpress.com/2006/12/06/any-application-defined-hook-procedure-on-my-machine/#comment-3769" title="">
	December 20, 2007 at 4:43 pm</a> </small>

	<p>I usually use WinDbg or .h file I have on my machine, but the net is
 a good alternative way. I don’t remember where I got the information 
about the structure you mentioned, and I don’t have on my hard disk 
anymore (it’s dead…).<br>
If you want to know something more about these specific structures you 
can use Windbg starting from _TEB (which is visible from Windbg for 
sure).<br>
In case I’ll find the structure’s definitions I’ll tell you.</p>
	
	<div class="reply">
		<a class="comment-reply-link" href="http://zairon.wordpress.com/2006/12/06/any-application-defined-hook-procedure-on-my-machine/?replytocom=3769#respond" onclick='return addComment.moveForm("div-comment-3769", "3769", "respond", "10")'>Reply</a>	</div>
	</div>
</li>
<li class="comment even thread-even depth-1" id="comment-3953">
	<div id="div-comment-3953">
	<div class="comment-author vcard">
		<img id="grav-6381c40d5ee5b45e86be6959c254792f-0" alt="" src="Any%20application-defined%20hook%20procedure%20on%20my%20machine%20%20%C2%AB%20My%20infected%20computer_files/6381c40d5ee5b45e86be6959c254792f.png" class="avatar avatar-48 grav-hashed grav-hijack" height="48" width="48">		<cite class="fn">Ermac</cite> <span class="says">Says:</span>	</div>
		<br>

	<small class="comment-meta commentmetadata"><a href="http://zairon.wordpress.com/2006/12/06/any-application-defined-hook-procedure-on-my-machine/#comment-3953" title="">
	December 30, 2007 at 4:17 am</a> </small>

	<p>Hello Zairon,<br>
Great article! Is there any way you could please post a source code 
example that you can share to list these hooks on Windows XP? I’m 
finding that these structures are rather confusing because most of the 
struct member names are very similar.</p>
	
	<div class="reply">
		<a class="comment-reply-link" href="http://zairon.wordpress.com/2006/12/06/any-application-defined-hook-procedure-on-my-machine/?replytocom=3953#respond" onclick='return addComment.moveForm("div-comment-3953", "3953", "respond", "10")'>Reply</a>	</div>
	</div>
</li>
<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-4383">
	<div id="div-comment-4383">
	<div class="comment-author vcard">
		<img id="grav-05f04bb85cf7a356818b2a8fc680d29b-0" alt="" src="Any%20application-defined%20hook%20procedure%20on%20my%20machine%20%20%C2%AB%20My%20infected%20computer_files/05f04bb85cf7a356818b2a8fc680d29b.png" class="avatar avatar-48 grav-hashed grav-hijack" height="48" width="48">		<cite class="fn">Hejo</cite> <span class="says">Says:</span>	</div>
		<br>

	<small class="comment-meta commentmetadata"><a href="http://zairon.wordpress.com/2006/12/06/any-application-defined-hook-procedure-on-my-machine/#comment-4383" title="">
	September 8, 2008 at 1:57 pm</a> </small>

	<p>Hello Zairon, stumbled over this old article of yours and I’m trying
 to construct a HookExplorer but keep finding my self in the deep end of
 the pool…. might be in over my head…<br>
You couldn’t by any chance post a complete example or mail me some source?</p>
<p>Regards</p>
	
	<div class="reply">
		<a class="comment-reply-link" href="http://zairon.wordpress.com/2006/12/06/any-application-defined-hook-procedure-on-my-machine/?replytocom=4383#respond" onclick='return addComment.moveForm("div-comment-4383", "4383", "respond", "10")'>Reply</a>	</div>
	</div>
</li>
<li class="comment even thread-even depth-1" id="comment-4384">
	<div id="div-comment-4384">
	<div class="comment-author vcard">
		<img id="grav-10e74d5bd54f570c4fd0e531471e72a2-0" alt="" src="Any%20application-defined%20hook%20procedure%20on%20my%20machine%20%20%C2%AB%20My%20infected%20computer_files/10e74d5bd54f570c4fd0e531471e72a2.png" class="avatar avatar-48 grav-hashed grav-hijack" height="48" width="48">		<cite class="fn">kalimako</cite> <span class="says">Says:</span>	</div>
		<br>

	<small class="comment-meta commentmetadata"><a href="http://zairon.wordpress.com/2006/12/06/any-application-defined-hook-procedure-on-my-machine/#comment-4384" title="">
	September 10, 2008 at 8:55 pm</a> </small>

	<p>I finally get the HOOK struct, I’m interested on global hooks only.</p>
<p> I get all information about my machine’s global hooks, but I have no
 idea how to get the module of the hook procedure, I mean, in the hook 
struct</p>
<p>typedef struct tagHOOK {   /* hk */<br>
    THRDESKHEAD head;<br>
    struct tagHOOK* pNext;<br>
    int iHook;<br>
    PVOID pfn;<br>
    UINT flags;<br>
    int imod;<br>
    PTHREADINFO     ptiHooked;<br>
    PDESKTOP        rpdesk;<br>
} HOOK;</p>
<p> pfn -&gt; is the offset of the procedure in the module…<br>
 imod -&gt; I assume that points to a module, but I have no idea how to translate that to a real dll path.</p>
<p> help!</p>
	
	<div class="reply">
		<a class="comment-reply-link" href="http://zairon.wordpress.com/2006/12/06/any-application-defined-hook-procedure-on-my-machine/?replytocom=4384#respond" onclick='return addComment.moveForm("div-comment-4384", "4384", "respond", "10")'>Reply</a>	</div>
	</div>
</li>
<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-4458">
	<div id="div-comment-4458">
	<div class="comment-author vcard">
		<img id="grav-879be563ad27025c9348670b3c69cdba-0" alt="" src="Any%20application-defined%20hook%20procedure%20on%20my%20machine%20%20%C2%AB%20My%20infected%20computer_files/879be563ad27025c9348670b3c69cdba.png" class="avatar avatar-48 grav-hashed grav-hijack" height="48" width="48">		<cite class="fn">mateus</cite> <span class="says">Says:</span>	</div>
		<br>

	<small class="comment-meta commentmetadata"><a href="http://zairon.wordpress.com/2006/12/06/any-application-defined-hook-procedure-on-my-machine/#comment-4458" title="">
	March 30, 2010 at 12:54 am</a> </small>

	<p>Hello, great article and great info! I’m not sure what I’m doing 
wrong. Or maybe I’m missing something. I have gotten all the code to 
compile, and (using kernel debugger) am able to   look at the structure 
for THREADINFO. The address all look good (refCount of_W32THREAD, 
pETHREAD, etc… However, my THREADINFO.pDeskInfo has an address 
of:0xbc640650. At which point, when i try to look at that memory 
address, i get a bunch of ????. Any clues as to what I could be doing 
wrong?</p>
	
	<div class="reply">
		<a class="comment-reply-link" href="http://zairon.wordpress.com/2006/12/06/any-application-defined-hook-procedure-on-my-machine/?replytocom=4458#respond" onclick='return addComment.moveForm("div-comment-4458", "4458", "respond", "10")'>Reply</a>	</div>
	</div>
</li>
<li class="comment even thread-even depth-1" id="comment-4593">
	<div id="div-comment-4593">
	<div class="comment-author vcard">
		<img id="grav-e4de19b2c60738b835c3aa5621dd1b0e-0" alt="" src="Any%20application-defined%20hook%20procedure%20on%20my%20machine%20%20%C2%AB%20My%20infected%20computer_files/e4de19b2c60738b835c3aa5621dd1b0e.png" class="avatar avatar-48 grav-hashed grav-hijack" height="48" width="48">		<cite class="fn">TBFisher</cite> <span class="says">Says:</span>	</div>
		<br>

	<small class="comment-meta commentmetadata"><a href="http://zairon.wordpress.com/2006/12/06/any-application-defined-hook-procedure-on-my-machine/#comment-4593" title="">
	December 16, 2010 at 2:39 am</a> </small>

	<p>THANKS! You have saved the day!! I have an app that depends heavily 
on a thread-specific hook in a listview control in a native C++ app. The
 OS(XP SP3) was arbitrarily dumping my HookProc and I had no way of 
easily detecting when the problem occurred. I used the methods in your 
code to build a DLL that allows me to monitor the status of my HookProc 
and reset it when necessary.<br>
Thanks again…</p>
<p>TF</p>
	
	<div class="reply">
		<a class="comment-reply-link" href="http://zairon.wordpress.com/2006/12/06/any-application-defined-hook-procedure-on-my-machine/?replytocom=4593#respond" onclick='return addComment.moveForm("div-comment-4593", "4593", "respond", "10")'>Reply</a>	</div>
	</div>
</li>
<li class="comment byuser comment-author-zairon bypostauthor odd alt thread-odd thread-alt depth-1" id="comment-4595">
	<div id="div-comment-4595">
	<div class="comment-author vcard">
		<img id="grav-96af3de97184170603a7cc688cbafeee-1" alt="" src="Any%20application-defined%20hook%20procedure%20on%20my%20machine%20%20%C2%AB%20My%20infected%20computer_files/96af3de97184170603a7cc688cbafeee.jpg" class="avatar avatar-48 grav-hashed grav-hijack" height="48" width="48">		<cite class="fn"><a href="http://zairon.wordpress.com/" rel="external nofollow" class="url">zairon</a></cite> <span class="says">Says:</span>	</div>
		<br>

	<small class="comment-meta commentmetadata"><a href="http://zairon.wordpress.com/2006/12/06/any-application-defined-hook-procedure-on-my-machine/#comment-4595" title="">
	January 10, 2011 at 3:42 pm</a> </small>

	<p>Glad to see someone finds it usefull! Thanks to you :)</p>
	
	<div class="reply">
		<a class="comment-reply-link" href="http://zairon.wordpress.com/2006/12/06/any-application-defined-hook-procedure-on-my-machine/?replytocom=4595#respond" onclick='return addComment.moveForm("div-comment-4595", "4595", "respond", "10")'>Reply</a>	</div>
	</div>
</li>
<li class="comment even thread-even depth-1" id="comment-4627">
	<div id="div-comment-4627">
	<div class="comment-author vcard">
		<img id="grav-3cf4b7e86b71f276f6c1f988cbf33051-0" alt="" src="Any%20application-defined%20hook%20procedure%20on%20my%20machine%20%20%C2%AB%20My%20infected%20computer_files/3cf4b7e86b71f276f6c1f988cbf33051.png" class="avatar avatar-48 grav-hashed grav-hijack" height="48" width="48">		<cite class="fn">Alexander</cite> <span class="says">Says:</span>	</div>
		<br>

	<small class="comment-meta commentmetadata"><a href="http://zairon.wordpress.com/2006/12/06/any-application-defined-hook-procedure-on-my-machine/#comment-4627" title="">
	March 20, 2011 at 1:08 pm</a> </small>

	<p>TBFisher, could you PLEASE share sourcecode of the function that checks status of the hook?</p>
<p>I have the same problem…</p>
	
	<div class="reply">
		<a class="comment-reply-link" href="http://zairon.wordpress.com/2006/12/06/any-application-defined-hook-procedure-on-my-machine/?replytocom=4627#respond" onclick='return addComment.moveForm("div-comment-4627", "4627", "respond", "10")'>Reply</a>	</div>
	</div>
</li>
	</ol>
	
	<div class="navigation">
	<div class="alignleft"></div>
	<div class="alignright"></div>
	</div>

	

									<div id="respond">
				<h3 id="reply-title">Leave a Reply <small><a rel="nofollow" id="cancel-comment-reply-link" href="http://zairon.wordpress.com/2006/12/06/any-application-defined-hook-procedure-on-my-machine/#respond" style="display: none;">Cancel reply</a></small></h3>
									<form action="http://zairon.wordpress.com/wp-comments-post.php" method="post" id="commentform">
																			<p class="comment-notes">Your email address will not be published. Required fields are marked <span class="required">*</span></p>							<p class="comment-form-author"><label for="author">Name</label> <span class="required">*</span><input id="author" name="author" size="30" aria-required="true" type="text"></p>
<p class="comment-form-email"><label for="email">Email</label> <span class="required">*</span><input id="email" name="email" size="30" aria-required="true" type="text"></p>
<p class="comment-form-url"><label for="url">Website</label><input id="url" name="url" size="30" type="text"></p>
												<p class="comment-form-comment"><label for="comment">Comment</label><textarea id="comment" name="comment" cols="45" rows="8" aria-required="true"></textarea></p>						<p class="form-allowed-tags">You may use these <abbr title="HyperText Markup Language">HTML</abbr> tags and attributes:  <code>&lt;a
 href="" title=""&gt; &lt;abbr title=""&gt; &lt;acronym title=""&gt; 
&lt;b&gt; &lt;blockquote cite=""&gt; &lt;cite&gt; &lt;code&gt; 
&lt;pre&gt; &lt;del datetime=""&gt; &lt;em&gt; &lt;i&gt; &lt;q 
cite=""&gt; &lt;strike&gt; &lt;strong&gt; </code></p>						<p class="form-submit">
							<input name="submit" id="submit" value="Post Comment" type="submit">
							<input name="comment_post_ID" value="10" id="comment_post_ID" type="hidden">
<input name="comment_parent" id="comment_parent" value="0" type="hidden">
						</p>
						
<input name="genseq" value="1306275512" type="hidden">
<p class="comment-subscription-form"><input name="subscribe" id="subscribe" value="subscribe" style="width: auto;" tabindex="6" type="checkbox"> <label class="subscribe-label" id="subscribe-label" for="subscribe">Notify me of follow-up comments via email.</label></p><p class="comment-subscription-form"><input name="subscribe_blog" id="subscribe_blog" value="subscribe" style="width: auto;" tabindex="7" type="checkbox"> <label class="subscribe-label" id="subscribe-blog-label" for="subscribe_blog">Notify me of new posts via email.</label></p><p style="display: none;"><input id="akismet_comment_nonce" name="akismet_comment_nonce" value="f2a47390e0" type="hidden"></p>					</form>
							</div><!-- #respond -->
						
			</div>
					<p align="center"></p>		
	</div>
	<div id="sidebar">
		<h2>Archived Entry</h2>
	<ul>
	<li><strong>Post Date :</strong></li>
	<li>December 6, 2006 at 12:01 am</li>
		<li><strong>Category :</strong></li>
	<li><a href="http://en.wordpress.com/tag/reverse-engineering/" title="View all posts in Reverse Engineering" rel="category tag">Reverse Engineering</a></li>
			<li><strong>Do More :</strong></li>
	<li>							You can <a href="#respond">leave a response</a>, or <a href="http://zairon.wordpress.com/2006/12/06/any-application-defined-hook-procedure-on-my-machine/trackback/" rel="trackback">trackback</a> from your own site.						
						</li>
	</ul>
		
	</div>
<p id="footer"><a href="http://wordpress.com/?ref=footer" rel="generator">Blog at WordPress.com</a>. — Theme: <a href="http://theme.wordpress.com/themes/connections/">Connections</a> by <a href="http://www.vanillamist.com/" rel="designer">www.vanillamist.com</a>.</p>

<script type="text/javascript">
// <![CDATA[
(function() {
try{
  if ( window.external &&'msIsSiteMode' in window.external) {
    if (window.external.msIsSiteMode()) {
      var jl = document.createElement('script');
      jl.type='text/javascript';
      jl.async=true;
      jl.src='/wp-content/plugins/ie-sitemode/custom-jumplist.php';
      var s = document.getElementsByTagName('script')[0];
      s.parentNode.insertBefore(jl, s);
    }
  }
}catch(e){}
})();
// ]]>
</script>	<script type="text/javascript">
	/* <![CDATA[ */
		jQuery( function() {
			
			jQuery('#wpl-button > a.like').click( function(e) {
				e.preventDefault();
				
				jQuery('#wpl-mustlogin').remove();

				jQuery.post( 'http://zairon.wordpress.com/wp-admin/admin-ajax.php', { 
					'action': 'wpl_record_stat',
					'stat_name': 'loggedout_like_click'
				} );

				var tenMins = new Date();
				tenMins.setTime( tenMins.getTime() + 600000 );
				document.cookie = 'wpl_rand=66212839c5; expires=' + tenMins.toGMTString() + '; domain=wordpress.com; path=/;';
				
				jQuery('#wpl-count').after( '\
					<div id="wpl-mustlogin"> \
						<form action="http://zairon.wordpress.com/wp-login.php" method="post"> \
							<p>Just one more step to like this post:</p> \
							<label><span>Username</span> <input type="text" name="log" id="user_login" class="input" value="" size="20" tabindex="80" /></label> \
							<label><span>Password</span> <input type="password" name="pwd" id="user_pass" class="input" value="" size="20" tabindex="81" /></label> \
							<input type="submit" name="wp-submit" id="wp-submit" class="button-primary" value="Log In" tabindex="82" /> \
							<input type="hidden" name="redirect_to" value="http://zairon.wordpress.com/2006/12/06/any-application-defined-hook-procedure-on-my-machine/?like=1" /> \
							<input type="hidden" name="wpl_rand" value="66212839c5" /> \
							<p>Not a member yet? <a href="http://wordpress.com/signup/?ref=likebox" id="wpl-signup-link">Sign up with WordPress.com</a></p> \
						</form> \
					</div> \
				');
				
				jQuery('#wpl-mustlogin').hide().slideDown('fast');
			} );
			
			jQuery('#wpl-mustlogin input.input').live( 'focus', function() {
				jQuery(this).prev().hide();
			}).live( 'blur', function() {
				if ( jQuery(this).val() == '' )
					jQuery(this).prev().show();
			});
			
			jQuery('#wpl-mustlogin input#wp-submit').live( 'click', function(e) {
				e.preventDefault();
				
				jQuery.post( 'http://zairon.wordpress.com/wp-admin/admin-ajax.php', { 
					'action': 'wpl_record_stat',
					'stat_name': 'loggedout_login_submit'
				}, function() {
					jQuery('#wpl-mustlogin form').submit();
				} );
			});			
			
			jQuery('#wpl-mustlogin a#wpl-signup-link').live( 'click', function(e) {
				e.preventDefault();
				
				var link = jQuery(this).attr('href');
				
				jQuery.post( 'http://zairon.wordpress.com/wp-admin/admin-ajax.php', { 
					'action': 'wpl_record_stat',
					'stat_name': 'loggedout_signup_click'
				}, function() {
					location.href = link;
				} );
			});					
			
		});
	/* ]]> */
	</script>
<script type="text/javascript">_qoptions={qacct:'p-18-mFEk4J448M',labels:'language.en,type.wpcom'};</script>
<script type="text/javascript" src="Any%20application-defined%20hook%20procedure%20on%20my%20machine%20%20%C2%AB%20My%20infected%20computer_files/quant.js"></script>
<noscript><p><img class="robots-nocontent" src="http://pixel.quantserve.com/pixel/p-18-mFEk4J448M.gif?labels=language.en%2Ctype.wpcom" style="display:none" height="1" width="1" alt="" /></p></noscript>
<script type="text/javascript" src="Any%20application-defined%20hook%20procedure%20on%20my%20machine%20%20%C2%AB%20My%20infected%20computer_files/gprofiles.js"></script>
<script type="text/javascript">
/* <![CDATA[ */
var WPGroHo = {
	my_hash: ""
};
/* ]]> */
</script>
<script type="text/javascript" src="Any%20application-defined%20hook%20procedure%20on%20my%20machine%20%20%C2%AB%20My%20infected%20computer_files/wpgroho.js"></script>
	<div style="display:none">
	<div class="grofile-hash-map-1c354712877789bbdd79815cca0598bf">
	</div>
	<div class="grofile-hash-map-96af3de97184170603a7cc688cbafeee">
	</div>
	<div class="grofile-hash-map-bea18e0707f35c13355e283a4a211b5e">
	</div>
	<div class="grofile-hash-map-05f04bb85cf7a356818b2a8fc680d29b">
	</div>
	<div class="grofile-hash-map-10e74d5bd54f570c4fd0e531471e72a2">
	</div>
	<div class="grofile-hash-map-879be563ad27025c9348670b3c69cdba">
	</div>
	<div class="grofile-hash-map-e4de19b2c60738b835c3aa5621dd1b0e">
	</div>
	<div class="grofile-hash-map-3cf4b7e86b71f276f6c1f988cbf33051">
	</div>
	</div>
<script type="text/javascript" src="Any%20application-defined%20hook%20procedure%20on%20my%20machine%20%20%C2%AB%20My%20infected%20computer_files/sharing.js"></script>
<script type="text/javascript" src="Any%20application-defined%20hook%20procedure%20on%20my%20machine%20%20%C2%AB%20My%20infected%20computer_files/beacon.js"></script><script type="text/javascript">try{COMSCORE.beacon({c1:2,c2:7518284});}catch(e){}</script><noscript><p class="robots-nocontent"><img src="http://b.scorecardresearch.com/p?cj=1c1=2&#038;c2=7518284" alt="" style="display:none" width="1" height="1" /></p></noscript><script src="Any%20application-defined%20hook%20procedure%20on%20my%20machine%20%20%C2%AB%20My%20infected%20computer_files/w.js" type="text/javascript"></script>
<script type="text/javascript">
st_go({'blog':'448309','v':'wpcom','user_id':'0','post':'10','subd':'zairon'});
ex_go({'crypt':'UE5XaFBLcG9HLE5XPUhlbC80Y21hP0dWSXxTWm04WUR+Ri12VFdkfHFSSmhbc3p+fnE0anQsVm5bVzBCQ2EzP05WMnQmRThbM1pvOE9taVtxPVp4UFcxWlBRUS5Ca0NSOS5dbGRlRz8vTWN3WEwwPV1jUVZ4LURXT0NjcWJqcVpyVn4mN1Y1ek9CfHFhTF9qOG5Kfk0xJl9aLWxSb0U4cktEZyxzN3lJLERLUlM3LC91WExDV3xLYXU1cGNWRXJ1RVhVdlhmWUxUPTldP2cw'});
addLoadEvent(function(){linktracker_init('448309',10);});
	</script><img id="wpstats" src="Any%20application-defined%20hook%20procedure%20on%20my%20machine%20%20%C2%AB%20My%20infected%20computer_files/g_002.gif" alt=""><img id="wpstats2" src="Any%20application-defined%20hook%20procedure%20on%20my%20machine%20%20%C2%AB%20My%20infected%20computer_files/g.gif" alt="" style="display: none;">
</div>
</div>


</body></html>